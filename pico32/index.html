<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>PIco32</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            iframe {
                overflow: hidden;
                border: none;
                margin: 0;
                vertical-align: top;
            }
            body {
                display: flex;
            }
            * {
                flex-shrink: 0;
            }
        </style>
    </head>

    <body style="background-color:#222">
        <iframe id="picotron" src="picotron.html" width="960" height="540"></iframe>
        <iframe id="pico8" src="pico8/pico8.html" width="512" height="512"></iframe>
    
        <script>
function doubleon() {
    document.getElementById("pico8")?.contentWindow?.p8_create_audio_context();
    document.getElementById("pico8")?.contentWindow?.p8_run_cart();
    setTimeout(() => {
        document.getElementById("picotron")?.contentWindow?.p8_create_audio_context();
        document.getElementById("picotron")?.contentWindow?.p8_run_cart();
    }, 348)
}

function waitForTrue(lambda) {
    return new Promise(r => {
        let int = setInterval(() => {
            if (lambda()) {
                clearInterval(int)
                r()
            }
        })
    })
}

async function setup_picotron() {
    console.log("waiting for picotron FS...")
    await waitForTrue(() => document.getElementById("picotron")?.contentWindow?.FS)
    
    let FS = document.getElementById("picotron")?.contentWindow?.FS

    let deviceID = 402; // arbitrary unique device ID
    
    // Define device operations, including read
    let ops = {
        read: function(stream, buffer, offset, length, position) {
            return 0;
        },
        write: function(stream, buffer, offset, length, position) {
            //console.log([stream, buffer, offset, length, position]);
            let data = String.fromCodePoint(...buffer.slice(offset, offset+length))
            console.log(data)
            data = data.slice(data.indexOf("\n")+1)
            if (data.length) {
                console.log(data)
                let toload = [Math.floor(Math.random()*255), ...[...data].map(x => x.charCodeAt(0))]
                while (toload.length < 128) {
                    toload.push(0)
                }
                document.getElementById("pico8").contentWindow.pico8_gpio = toload
            }
            // console.log(JSON.stringify([...buffer.slice(offset, offset+length)]))
            return length;
        }
    };
    
    FS.registerDevice(deviceID, ops);
        
    let path = "/picotron/appdata/gpio"
    
    console.log("waiting for picotron /appdata...")
    await waitForTrue(() => FS.analyzePath("/picotron/appdata").exists)
    console.log("activate picotron!")
    try {
        if (FS.analyzePath(path).exists) {
            FS.unlink(path)
        }
    } catch (e) {console.log("unlink fail", e)}
    FS.mkdev(path, deviceID, deviceID);
}

console.log("gonna setup")
setup_picotron()
        </script>
    </body>
</html>
